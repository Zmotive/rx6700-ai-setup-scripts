---
# AI ROCm Docker Setup - Ansible Playbook (Fixed Version)
# This version avoids the become hanging issue

- name: Setup AI System with ROCm and Docker
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    rocm_version: "6.1"
    user_name: "{{ target_user | default(ansible_env.USER | default(ansible_user_id)) }}"
    
  tasks:
    # ===============================================
    # INITIAL SETUP WITHOUT BECOME
    # ===============================================
    
    - name: Gather facts
      setup:
      tags: [always]
    
    - name: Check if we can sudo without password
      shell: sudo -n true
      register: sudo_check
      failed_when: false
      changed_when: false
      check_mode: no
      tags: [always]
    
    - name: Prompt for sudo password if needed
      pause:
        prompt: "This playbook requires sudo privileges. Please enter your sudo password"
        echo: no
      register: sudo_pass
      when: sudo_check.rc != 0
      tags: [always]
    
    # ===============================================
    # PREREQUISITES AND VALIDATION
    # ===============================================
    
    - name: Check Ubuntu version
      assert:
        that:
          - ansible_distribution == "Ubuntu"
          - ansible_distribution_version == "22.04"
        fail_msg: "This playbook requires Ubuntu 22.04 LTS"
        success_msg: "Ubuntu 22.04 LTS confirmed"
      tags: [prerequisites]

    - name: Check for AMD GPU
      shell: lspci | grep -i amd | grep -i vga
      register: amd_gpu_check
      failed_when: false
      changed_when: false
      check_mode: no
      tags: [prerequisites]

    - name: Display GPU information
      debug:
        msg: "AMD GPU detected: {{ amd_gpu_check.stdout }}"
      when: amd_gpu_check.rc == 0
      tags: [prerequisites]

    # ===============================================
    # SYSTEM UPDATE
    # ===============================================
    
    - name: Update package cache
      shell: sudo apt update
      register: apt_update
      changed_when: "'upgraded' in apt_update.stdout"
      tags: [system_update]
    
    - name: Upgrade system packages
      shell: sudo apt upgrade -y
      register: apt_upgrade
      changed_when: "'upgraded' in apt_upgrade.stdout"
      tags: [system_update]

    # ===============================================
    # DOCKER INSTALLATION
    # ===============================================
    
    - name: Remove old Docker packages
      shell: sudo apt remove -y docker docker-engine docker.io containerd runc || true
      register: docker_remove
      changed_when: "'Removing' in docker_remove.stdout"
      tags: [docker]
    
    - name: Install Docker dependencies
      shell: |
        sudo apt install -y \
          ca-certificates \
          curl \
          gnupg \
          lsb-release
      register: docker_deps
      changed_when: "'newly installed' in docker_deps.stdout"
      tags: [docker]
    
    - name: Add Docker GPG key
      shell: |
        sudo mkdir -p /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg || true
      args:
        creates: /etc/apt/keyrings/docker.gpg
      tags: [docker]
    
    - name: Add Docker repository
      shell: |
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
      args:
        creates: /etc/apt/sources.list.d/docker.list
      tags: [docker]
    
    - name: Update package cache after adding Docker repo
      shell: sudo apt update
      register: apt_update_docker
      changed_when: "'Reading package lists' in apt_update_docker.stdout"
      tags: [docker]
    
    - name: Install Docker Engine
      shell: |
        sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
      register: docker_install
      changed_when: "'newly installed' in docker_install.stdout"
      tags: [docker]
    
    - name: Add user to docker group
      shell: sudo usermod -aG docker {{ user_name }}
      register: docker_group
      changed_when: true
      tags: [docker]

    # ===============================================
    # ROCM INSTALLATION
    # ===============================================
    
    - name: Remove conflicting ROCm packages
      shell: |
        sudo apt remove -y rocm-cmake rocm-device-libs rocminfo || true
        sudo apt autoremove -y || true
      register: rocm_cleanup
      changed_when: "'Removing' in rocm_cleanup.stdout"
      tags: [rocm]
    
    - name: Create ROCm keyrings directory
      shell: sudo mkdir -p --mode=0755 /etc/apt/keyrings
      args:
        creates: /etc/apt/keyrings
      tags: [rocm]
    
    - name: Add ROCm GPG key
      shell: |
        wget https://repo.radeon.com/rocm/rocm.gpg.key -O - | gpg --dearmor | sudo tee /etc/apt/keyrings/rocm.gpg > /dev/null
      args:
        creates: /etc/apt/keyrings/rocm.gpg
      tags: [rocm]
    
    - name: Add ROCm repository
      shell: |
        echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/rocm.gpg] https://repo.radeon.com/rocm/apt/6.1 jammy main" | sudo tee /etc/apt/sources.list.d/rocm.list
      args:
        creates: /etc/apt/sources.list.d/rocm.list
      tags: [rocm]
    
    - name: Update package cache after adding ROCm repo
      shell: sudo apt update
      register: apt_update_rocm
      changed_when: "'Reading package lists' in apt_update_rocm.stdout"
      tags: [rocm]
    
    - name: Install ROCm core dependencies with specific versions
      shell: |
        sudo apt install -y \
        rocm-cmake=0.12.0.60100-82~22.04 \
        rocm-device-libs=1.0.0.60100-82~22.04 \
        rocminfo=1.0.0.60100-82~22.04
      register: rocm_deps
      changed_when: "'newly installed' in rocm_deps.stdout"
      tags: [rocm]
    
    - name: Check which ROCm packages are already installed
      shell: dpkg -l | grep -E "(rocm-dev|rocm-libs|rocm-utils)" || true
      register: rocm_check
      changed_when: false
      tags: [rocm]
    
    - name: Display ROCm package status
      debug:
        msg: "ROCm packages status: {{ rocm_check.stdout_lines }}"
      tags: [rocm]
    
    - name: Install ROCm packages (with timeout and detailed output)
      shell: |
        timeout 300 sudo apt install -y rocm-dev rocm-libs rocm-utils 2>&1 || echo "Installation timed out or completed"
      register: rocm_install
      changed_when: "'newly installed' in rocm_install.stdout"
      failed_when: false
      tags: [rocm]
    
    - name: Display ROCm installation output
      debug:
        msg: "ROCm installation output: {{ rocm_install.stdout_lines }}"
      tags: [rocm]
    
    - name: Add user to render group
      shell: sudo usermod -aG render {{ user_name }}
      register: render_group
      changed_when: true
      tags: [rocm]
    
    - name: Add user to video group
      shell: sudo usermod -aG video {{ user_name }}
      register: video_group
      changed_when: true
      tags: [rocm]

    # ===============================================
    # ENVIRONMENT CONFIGURATION
    # ===============================================
    
    - name: Add ROCm to PATH in bashrc
      lineinfile:
        path: "/home/{{ user_name }}/.bashrc"
        line: "export PATH=/opt/rocm/bin:$PATH"
        create: yes
      tags: [environment]
    
    - name: Add ROCm_ROOT to bashrc
      lineinfile:
        path: "/home/{{ user_name }}/.bashrc"
        line: "export ROCm_ROOT=/opt/rocm"
        create: yes
      tags: [environment]
    
    # ===============================================
    # WORKSPACE DIRECTORY CREATION
    # ===============================================
    
    - name: Create AI workspace directories
      file:
        path: "/home/{{ user_name }}/ai-workspace/{{ item }}"
        state: directory
        mode: '0755'
        owner: "{{ user_name }}"
        group: "{{ user_name }}"
      loop:
        - DockerVolumes
        - DockerVolumes/pytorch
        - DockerVolumes/tensorflow
        - DockerVolumes/jupyter
        - DockerVolumes/shared
        - DockerVolumes/tensorboard
        - DockerVolumes/datasets
        - DockerVolumes/checkpoints
        - DockerVolumes/logs
        - Models
        - Models/pytorch
        - Models/tensorflow
        - Models/onnx
        - Models/huggingface
        - Projects
        - Projects/ai-experiments
        - Projects/training
        - Projects/inference
        - venvs
      tags: [workspace]

    # ===============================================
    # TEMPLATE AND TEST FILES
    # Note: These directories are in .gitignore since they're auto-generated
    # ===============================================
    
    - name: Create templates directory
      file:
        path: "{{ ansible_env.PWD }}/templates"
        state: directory
        mode: '0755'
      tags: [templates]

    - name: Create tests directory
      file:
        path: "{{ ansible_env.PWD }}/tests"
        state: directory
        mode: '0755'
      tags: [templates]

    - name: Create Docker Compose template
      copy:
        content: |
          services:
            pytorch-rocm:
              image: rocm/pytorch:latest
              container_name: pytorch-rocm
              devices:
                - /dev/kfd:/dev/kfd
                - /dev/dri:/dev/dri
              group_add:
                - "44"    # video group
                - "109"   # render group
              ipc: host
              cap_add:
                - SYS_PTRACE
              security_opt:
                - seccomp:unconfined
              volumes:
                - ~/ai-workspace/Projects:/workspace/Projects
                - ~/ai-workspace/Models:/workspace/Models
                - ~/ai-workspace/DockerVolumes/pytorch:/workspace/data
              working_dir: /workspace
              environment:
                - HIP_PLATFORM=amd
                - HSA_OVERRIDE_GFX_VERSION=10.3.0  # Adjust for your GPU
              stdin_open: true
              tty: true
              restart: unless-stopped

            tensorflow-rocm:
              image: rocm/tensorflow:latest
              container_name: tensorflow-rocm
              devices:
                - /dev/kfd:/dev/kfd
                - /dev/dri:/dev/dri
              group_add:
                - "44"    # video group
                - "109"   # render group
              ipc: host
              cap_add:
                - SYS_PTRACE
              security_opt:
                - seccomp:unconfined
              volumes:
                - ~/ai-workspace/Projects:/workspace/Projects
                - ~/ai-workspace/Models:/workspace/Models
                - ~/ai-workspace/DockerVolumes/tensorflow:/workspace/data
              working_dir: /workspace
              environment:
                - HIP_PLATFORM=amd
              stdin_open: true
              tty: true
              restart: unless-stopped

            jupyter-rocm:
              image: rocm/pytorch:latest
              container_name: jupyter-rocm
              devices:
                - /dev/kfd:/dev/kfd
                - /dev/dri:/dev/dri
              group_add:
                - "44"    # video group
                - "109"   # render group
              ipc: host
              cap_add:
                - SYS_PTRACE
              security_opt:
                - seccomp:unconfined
              volumes:
                - ~/ai-workspace/Projects:/workspace/Projects
                - ~/ai-workspace/Models:/workspace/Models
                - ~/ai-workspace/DockerVolumes/jupyter:/workspace/data
              working_dir: /workspace
              environment:
                - HIP_PLATFORM=amd
                - HSA_OVERRIDE_GFX_VERSION=10.3.0
              ports:
                - "8888:8888"
              command: >
                bash -c "pip install jupyter jupyterlab &&
                         jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root --NotebookApp.token='' --NotebookApp.password=''"
              stdin_open: true
              tty: true
              restart: unless-stopped

          networks:
            default:
              driver: bridge
        dest: "{{ ansible_env.PWD }}/templates/docker-compose.ai-template.yml"
        mode: '0644'
      tags: [templates]

    - name: Create ROCm Docker test script
      copy:
        content: |
          #!/bin/bash
          # Test ROCm functionality in Docker

          echo "Testing ROCm Docker integration..."

          # Test basic ROCm functionality
          echo "1. Testing basic ROCm info..."
          docker run --rm --device=/dev/kfd --device=/dev/dri --group-add 44 --group-add 109 \
              rocm/rocm-terminal:latest rocminfo | head -20

          echo -e "\n2. Testing PyTorch ROCm container..."
          docker run --rm --device=/dev/kfd --device=/dev/dri --group-add 44 --group-add 109 \
              -v ~/ai-workspace/Projects:/workspace/Projects:rw \
              -v ~/ai-workspace/Models:/workspace/Models:rw \
              rocm/pytorch:latest python3 -c "
          import torch
          print(f'PyTorch version: {torch.__version__}')
          print(f'ROCm available: {torch.cuda.is_available()}')
          if torch.cuda.is_available():
              print(f'GPU device: {torch.cuda.get_device_name(0)}')
              print(f'GPU count: {torch.cuda.device_count()}')
              # Test tensor operations
              x = torch.randn(3, 3).cuda()
              print(f'Created tensor on GPU: {x.device}')
              y = x @ x
              print(f'Matrix multiplication completed on GPU')
          else:
              print('No ROCm devices detected')
          "

          echo -e "\n3. Testing TensorFlow ROCm container..."
          docker run --rm --device=/dev/kfd --device=/dev/dri --group-add 44 --group-add 109 \
              -v ~/ai-workspace/Projects:/workspace/Projects:rw \
              -v ~/ai-workspace/Models:/workspace/Models:rw \
              rocm/tensorflow:latest python3 -c "
          import tensorflow as tf
          print(f'TensorFlow version: {tf.__version__}')
          gpus = tf.config.list_physical_devices('GPU')
          print(f'GPU devices: {len(gpus)}')
          if gpus:
              print(f'GPU details: {gpus[0]}')
          else:
              print('No GPU devices detected')
          "

          echo -e "\n4. Testing Docker Compose services..."
          if [ -f ~/ai-workspace/Projects/docker-compose.yml ]; then
              echo "Found docker-compose.yml, testing service start..."
              cd ~/ai-workspace/Projects
              docker compose up -d pytorch-rocm
              sleep 5
              docker compose ps
              echo "Testing ROCm in compose service..."
              docker compose exec pytorch-rocm python3 -c "import torch; print(f'ROCm available in compose: {torch.cuda.is_available()}')"
              docker compose down
          else
              echo "No docker-compose.yml found in ~/ai-workspace/Projects/"
              echo "Copy template: cp ~/ai-setup-scripts/ansible/templates/docker-compose.ai-template.yml ~/ai-workspace/Projects/docker-compose.yml"
          fi

          echo -e "\nROCm Docker test completed!"
          echo "If all tests passed, your ROCm Docker setup is working correctly!"
        dest: "{{ ansible_env.PWD }}/tests/test-rocm-docker.sh"
        mode: '0755'
      tags: [templates]

    # ===============================================
    # COMPLETION MESSAGE
    # ===============================================
    
    - name: Display completion message
      debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════╗
          ║                    SETUP COMPLETED!                         ║
          ╚══════════════════════════════════════════════════════════════╝
          
          IMPORTANT NEXT STEPS:
          1. REBOOT YOUR SYSTEM to ensure all changes take effect
          2. After reboot, test the installation:
             - docker run --rm hello-world
             - rocminfo
             - ./tests/test-rocm-docker.sh
          3. Start using your AI workspace:
             - ~/ai-workspace/DockerVolumes/ - Container persistent storage
             - ~/ai-workspace/Models/ - AI models and weights
             - ~/ai-workspace/Projects/ - Your AI projects
             - ~/ai-workspace/venvs/ - Python virtual environments
          4. Use Docker Compose template:
             - cd ~/ai-workspace/Projects
             - cp {{ ansible_env.PWD }}/templates/docker-compose.ai-template.yml docker-compose.yml
             - docker compose up -d pytorch-rocm
          
          Remember to log out and back in (or reboot) for group changes to take effect!
      tags: [always]