---
# AI ROCm Docker Setup - Ansible Playbook (Fixed Version)
# This version avoids the become hanging issue

- name: Setup AI System with ROCm and Docker
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    rocm_version: "6.4"
    user_name: "{{ target_user | default(ansible_env.USER | default(ansible_user_id)) }}"
    
  tasks:
    # ===============================================
    # INITIAL SETUP WITHOUT BECOME
    # ===============================================
    
    - name: Gather facts
      setup:
      tags: [always]
    
    - name: Check if we can sudo without password
      shell: sudo -n true
      register: sudo_check
      failed_when: false
      changed_when: false
      check_mode: no
      tags: [always]
    
    - name: Prompt for sudo password if needed
      pause:
        prompt: "This playbook requires sudo privileges. Please enter your sudo password"
        echo: no
      register: sudo_pass
      when: sudo_check.rc != 0
      tags: [always]
    
    # ===============================================
    # PREREQUISITES AND VALIDATION
    # ===============================================
    
    - name: Check Ubuntu version
      assert:
        that:
          - ansible_distribution == "Ubuntu"
          - ansible_distribution_version == "22.04"
        fail_msg: "This playbook requires Ubuntu 22.04 LTS"
        success_msg: "Ubuntu 22.04 LTS confirmed"
      tags: [prerequisites]

    - name: Check for AMD GPU
      shell: lspci | grep -i amd | grep -i vga
      register: amd_gpu_check
      failed_when: false
      changed_when: false
      check_mode: no
      tags: [prerequisites]

    - name: Display GPU information
      debug:
        msg: "AMD GPU detected: {{ amd_gpu_check.stdout }}"
      when: amd_gpu_check.rc == 0
      tags: [prerequisites]

    # ===============================================
    # SYSTEM UPDATE
    # ===============================================
    
    - name: Update package cache
      shell: sudo apt update
      register: apt_update
      changed_when: "'upgraded' in apt_update.stdout"
      tags: [system_update]
    
    - name: Upgrade system packages
      shell: sudo apt upgrade -y
      register: apt_upgrade
      changed_when: "'upgraded' in apt_upgrade.stdout"
      tags: [system_update]

    # ===============================================
    # DOCKER INSTALLATION
    # ===============================================
    
    - name: Remove old Docker packages
      shell: sudo apt remove -y docker docker-engine docker.io containerd runc || true
      register: docker_remove
      changed_when: "'Removing' in docker_remove.stdout"
      tags: [docker]
    
    - name: Install Docker dependencies
      shell: |
        sudo apt install -y \
          ca-certificates \
          curl \
          gnupg \
          lsb-release
      register: docker_deps
      changed_when: "'newly installed' in docker_deps.stdout"
      tags: [docker]
    
    - name: Add Docker GPG key
      shell: |
        sudo mkdir -p /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg || true
      args:
        creates: /etc/apt/keyrings/docker.gpg
      tags: [docker]
    
    - name: Add Docker repository
      shell: |
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
      args:
        creates: /etc/apt/sources.list.d/docker.list
      tags: [docker]
    
    - name: Update package cache after adding Docker repo
      shell: sudo apt update
      register: apt_update_docker
      changed_when: "'Reading package lists' in apt_update_docker.stdout"
      tags: [docker]
    
    - name: Install Docker Engine
      shell: |
        sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
      register: docker_install
      changed_when: "'newly installed' in docker_install.stdout"
      tags: [docker]
    
    - name: Add user to docker group
      shell: sudo usermod -aG docker {{ user_name }}
      register: docker_group
      changed_when: true
      tags: [docker]

    # ===============================================
    # ROCM INSTALLATION
    # ===============================================
    
    - name: Remove conflicting ROCm packages
      shell: |
        sudo apt remove -y rocm-cmake rocm-device-libs rocminfo || true
        sudo apt autoremove -y || true
      register: rocm_cleanup
      changed_when: "'Removing' in rocm_cleanup.stdout"
      tags: [rocm]
    
    - name: Create ROCm keyrings directory
      shell: sudo mkdir -p --mode=0755 /etc/apt/keyrings
      args:
        creates: /etc/apt/keyrings
      tags: [rocm]
    
    - name: Add ROCm GPG key
      shell: |
        wget https://repo.radeon.com/rocm/rocm.gpg.key -O - | gpg --dearmor | sudo tee /etc/apt/keyrings/rocm.gpg > /dev/null
      args:
        creates: /etc/apt/keyrings/rocm.gpg
      tags: [rocm]
    
    - name: Add ROCm repository
      shell: |
        echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/rocm.gpg] https://repo.radeon.com/rocm/apt/{{ rocm_version }} jammy main" | sudo tee /etc/apt/sources.list.d/rocm.list
      register: rocm_repo
      changed_when: true
      tags: [rocm]
    
    - name: Update package cache after adding ROCm repo
      shell: sudo apt update
      register: apt_update_rocm
      changed_when: "'Reading package lists' in apt_update_rocm.stdout"
      tags: [rocm]
    
    - name: Remove any existing ROCm packages from Ubuntu repos
      shell: |
        sudo apt remove -y rocm-cmake rocm-device-libs rocminfo libhsa-runtime64-1 libhsakmt1 || true
        sudo apt autoremove -y || true
      register: rocm_cleanup_ubuntu
      changed_when: "'Removing' in rocm_cleanup_ubuntu.stdout"
      tags: [rocm]
    
    - name: Install ROCm core dependencies from ROCm 6.4 repo
      shell: |
        sudo apt install -y \
        rocm-core=6.4.0.60400-47~22.04 \
        rocm-cmake=0.14.0.60400-47~22.04 \
        rocm-device-libs=1.0.0.60400-47~22.04 \
        rocminfo=1.0.0.60400-47~22.04
      register: rocm_deps
      changed_when: "'newly installed' in rocm_deps.stdout"
      tags: [rocm]
    
    - name: Check which ROCm packages are already installed
      shell: dpkg -l | grep -E "(rocm-dev|rocm-libs|rocm-utils)" || true
      register: rocm_check
      changed_when: false
      tags: [rocm]
    
    - name: Display ROCm package status
      debug:
        msg: "ROCm packages status: {{ rocm_check.stdout_lines }}"
      tags: [rocm]
    
    - name: Install minimal ROCm packages (rocminfo for GPU verification only)
      shell: |
        sudo apt install -y rocm-core rocm-cmake rocm-device-libs rocminfo rocm-smi-lib 2>&1
      register: rocm_install
      changed_when: "'newly installed' in rocm_install.stdout or 'upgraded' in rocm_install.stdout"
      failed_when: "rocm_install.rc != 0"
      tags: [rocm]
    
    - name: Display ROCm installation output
      debug:
        msg: "ROCm installation output: {{ rocm_install.stdout_lines }}"
      tags: [rocm]
    
    - name: Add user to render group
      shell: sudo usermod -aG render {{ user_name }}
      register: render_group
      changed_when: true
      tags: [rocm]
    
    - name: Add user to video group
      shell: sudo usermod -aG video {{ user_name }}
      register: video_group
      changed_when: true
      tags: [rocm]

    # ===============================================
    # ENVIRONMENT CONFIGURATION
    # ===============================================
    
    - name: Add ROCm to PATH in bashrc
      lineinfile:
        path: "/home/{{ user_name }}/.bashrc"
        line: "export PATH=/opt/rocm/bin:$PATH"
        create: yes
      tags: [environment]
    
    - name: Add ROCm_ROOT to bashrc
      lineinfile:
        path: "/home/{{ user_name }}/.bashrc"
        line: "export ROCm_ROOT=/opt/rocm"
        create: yes
      tags: [environment]
    
    # ===============================================
    # WORKSPACE DIRECTORY CREATION
    # ===============================================
    
    - name: Create AI workspace directories
      file:
        path: "/home/{{ user_name }}/ai-workspace/{{ item }}"
        state: directory
        mode: '0755'
        owner: "{{ user_name }}"
        group: "{{ user_name }}"
      loop:
        - DockerVolumes
        - DockerVolumes/pytorch
        - DockerVolumes/tensorflow
        - DockerVolumes/jupyter
        - DockerVolumes/shared
        - DockerVolumes/tensorboard
        - DockerVolumes/datasets
        - DockerVolumes/checkpoints
        - DockerVolumes/logs
        - Models
        - Models/pytorch
        - Models/tensorflow
        - Models/onnx
        - Models/huggingface
        - Projects
        - Projects/ai-experiments
        - Projects/training
        - Projects/inference
        - venvs
      tags: [workspace]

    # ===============================================
    # COMPLETION MESSAGE
    # ===============================================
    
    - name: Display completion message
      debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════╗
          ║                    SETUP COMPLETED!                          ║
          ╚══════════════════════════════════════════════════════════════╝
          
          IMPORTANT NEXT STEPS:
          1. REBOOT YOUR SYSTEM to ensure all changes take effect
          2. After reboot, test the installation:
             - docker run --rm hello-world
             - rocminfo
             - {{ ansible_env.PWD }}/ansible/tests/test-rocm-docker.sh
          3. Start using your AI workspace:
             - ~/ai-workspace/DockerVolumes/ - Container persistent storage
             - ~/ai-workspace/Models/ - AI models and weights
             - ~/ai-workspace/Projects/ - Your AI projects
             - ~/ai-workspace/venvs/ - Python virtual environments
          4. Use Docker Compose templates (in version control):
             - cd ~/ai-workspace/Projects
             - cp {{ ansible_env.PWD }}/ansible/templates/docker-compose.ai-template.yml docker-compose.yml
             - docker compose up -d pytorch-rocm
          5. For Stable Diffusion (Phase 1 optimizations):
             - See ~/ai-workspace/Projects/testing/SCALING_SOLUTIONS.md
             - Supports 768×768 resolution (9.3s per image)
          6. Documentation:
             - Setup guide: {{ ansible_env.PWD }}/SETUP-NOTES.md
             - Troubleshooting: {{ ansible_env.PWD }}/TROUBLESHOOTING.md
          
          Remember to log out and back in (or reboot) for group changes to take effect!
      tags: [always]