---
# AI ROCm Docker Setup - Ansible Playbook
# Complete setup for Ubuntu 22.04 LTS with AMD GPU, ROCm 6.1, and Docker
# Based on the original shell scripts but made idempotent and declarative

- name: Setup AI System with ROCm and Docker
  hosts: localhost
  connection: local
  become: yes
  vars:
    rocm_version: "6.1"
    user_name: "{{ ansible_user_id }}"
    home_dir: "{{ ansible_env.HOME }}"
    
  tasks:
    # ===============================================
    # PREREQUISITES AND VALIDATION
    # ===============================================
    
    - name: Check Ubuntu version
      assert:
        that:
          - ansible_distribution == "Ubuntu"
          - ansible_distribution_version == "22.04"
        fail_msg: "This playbook requires Ubuntu 22.04 LTS"
        success_msg: "Ubuntu 22.04 LTS confirmed"
      tags: [prerequisites]

    - name: Check for AMD GPU
      shell: lspci | grep -i amd | grep -i vga
      register: amd_gpu_check
      failed_when: false
      changed_when: false
      tags: [prerequisites]

    - name: Display GPU information
      debug:
        msg: "AMD GPU detected: {{ amd_gpu_check.stdout }}"
      when: amd_gpu_check.rc == 0
      tags: [prerequisites]

    - name: Warn if no AMD GPU detected
      debug:
        msg: "WARNING: No AMD GPU detected. ROCm installation may not work properly."
      when: amd_gpu_check.rc != 0
      tags: [prerequisites]

    - name: Test internet connectivity
      uri:
        url: https://google.com
        method: HEAD
        timeout: 5
      tags: [prerequisites]

    # ===============================================
    # SYSTEM PREPARATION
    # ===============================================
    
    - name: Update APT cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: [system]

    - name: Upgrade all packages
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes
      tags: [system]

    - name: Install base packages
      apt:
        name:
          - curl
          - wget
          - gnupg
          - lsb-release
          - software-properties-common
          - apt-transport-https
          - ca-certificates
          - build-essential
          - git
          - vim
          - htop
          - tree
          - unzip
          - python3
          - python3-pip
          - python3-venv
        state: present
      tags: [system]

    - name: Remove old ROCm sources
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apt/sources.list.d/rocm.list
        - /etc/apt/keyrings/rocm.gpg
      tags: [cleanup]

    - name: Stop old Docker services
      systemd:
        name: "{{ item }}"
        state: stopped
      loop:
        - docker
        - docker.socket
        - containerd
      failed_when: false
      tags: [cleanup]

    - name: Remove old Docker packages
      apt:
        name:
          - docker
          - docker-engine
          - docker.io
          - containerd
          - runc
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: absent
      tags: [cleanup]

    - name: Remove old Docker data directories
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /var/lib/docker
        - /etc/docker
        - /var/lib/containerd
      tags: [cleanup]

    - name: Remove old ROCm directory if not a symlink
      file:
        path: /opt/rocm
        state: absent
      when: ansible_facts.get('ansible_symlink_target') is not defined
      tags: [cleanup]

    # ===============================================
    # WORKSPACE DIRECTORY CREATION
    # ===============================================
    
    - name: Create AI workspace directories
      file:
        path: "{{ home_dir }}/{{ item }}"
        state: directory
        mode: '0755'
        owner: "{{ user_name }}"
        group: "{{ user_name }}"
      loop:
        - DockerVolumes
        - DockerVolumes/pytorch
        - DockerVolumes/tensorflow
        - DockerVolumes/jupyter
        - DockerVolumes/shared
        - DockerVolumes/tensorboard
        - DockerVolumes/datasets
        - DockerVolumes/checkpoints
        - DockerVolumes/logs
        - Models
        - Models/pytorch
        - Models/tensorflow
        - Models/onnx
        - Models/huggingface
        - Projects
        - Projects/ai-experiments
        - Projects/training
        - Projects/inference
        - venvs
      become: no
      tags: [workspace]

    # ===============================================
    # ROCM INSTALLATION
    # ===============================================
    
    - name: Create APT keyrings directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      tags: [rocm]

    - name: Add ROCm GPG key
      get_url:
        url: https://repo.radeon.com/rocm/rocm.gpg.key
        dest: /tmp/rocm.gpg.key
        mode: '0644'
      tags: [rocm]

    - name: Import ROCm GPG key
      shell: gpg --dearmor < /tmp/rocm.gpg.key > /etc/apt/keyrings/rocm.gpg
      args:
        creates: /etc/apt/keyrings/rocm.gpg
      tags: [rocm]

    - name: Add ROCm repository
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/rocm.gpg] https://repo.radeon.com/rocm/apt/{{ rocm_version }} jammy main"
        filename: rocm
        state: present
      tags: [rocm]

    - name: Set ROCm repository priority
      copy:
        content: |
          Package: *
          Pin: release o=repo.radeon.com
          Pin-Priority: 600
        dest: /etc/apt/preferences.d/rocm-pin-600
        mode: '0644'
      tags: [rocm]

    - name: Update APT cache after adding ROCm repository
      apt:
        update_cache: yes
      tags: [rocm]

    - name: Install ROCm packages
      apt:
        name:
          - rocm-dev
          - rocm-libs
          - rocm-utils
          - rocminfo
          - rocm-smi-lib
          - hip-dev
          - rocblas-dev
          - rocfft-dev
          - rocsolver-dev
          - rccl-dev
          - miopen-hip-dev
          - rocrand-dev
          - hipsparse-dev
        state: present
      tags: [rocm]

    - name: Create ROCm symlink
      file:
        src: "/opt/rocm-{{ rocm_version }}.0"
        dest: /opt/rocm
        state: link
        force: yes
      tags: [rocm]

    - name: Create ROCm environment script
      copy:
        content: |
          #!/bin/bash
          # ROCm Environment Setup
          export ROCM_PATH=/opt/rocm
          export PATH=$ROCM_PATH/bin:$PATH
          export LD_LIBRARY_PATH=$ROCM_PATH/lib:${LD_LIBRARY_PATH:-}
          export HIP_PATH=$ROCM_PATH
          export DEVICE_LIB_PATH=$ROCM_PATH/amdgcn/bitcode
          export HSA_PATH=$ROCM_PATH
        dest: /etc/profile.d/rocm.sh
        mode: '0755'
      tags: [rocm]

    # ===============================================
    # DOCKER INSTALLATION
    # ===============================================
    
    - name: Add Docker GPG key
      get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /tmp/docker.gpg.key
        mode: '0644'
      tags: [docker]

    - name: Import Docker GPG key
      shell: gpg --dearmor < /tmp/docker.gpg.key > /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg
      tags: [docker]

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        filename: docker
        state: present
      tags: [docker]

    - name: Install Docker packages
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
      tags: [docker]

    - name: Create Docker daemon configuration
      copy:
        content: |
          {
              "log-driver": "json-file",
              "log-opts": {
                  "max-size": "10m",
                  "max-file": "3"
              },
              "storage-driver": "overlay2",
              "runtimes": {
                  "rocm": {
                      "path": "/usr/bin/rocmrun",
                      "runtimeArgs": []
                  }
              },
              "default-ulimits": {
                  "memlock": {
                      "Hard": -1,
                      "Name": "memlock",
                      "Soft": -1
                  },
                  "stack": {
                      "Hard": 67108864,
                      "Name": "stack",
                      "Soft": 67108864
                  }
              }
          }
        dest: /etc/docker/daemon.json
        mode: '0644'
      notify: restart docker
      tags: [docker]

    - name: Enable and start Docker services
      systemd:
        name: "{{ item }}"
        enabled: yes
        state: started
      loop:
        - docker
        - containerd
      tags: [docker]

    # ===============================================
    # USER PERMISSIONS
    # ===============================================
    
    - name: Add user to system groups
      user:
        name: "{{ user_name }}"
        groups: "{{ item }}"
        append: yes
      loop:
        - render
        - video
        - docker
      tags: [permissions]

    # ===============================================
    # TEMPLATE AND TEST FILES
    # Note: These directories are in .gitignore since they're auto-generated
    # ===============================================
    
    - name: Create templates directory
      file:
        path: "{{ ansible_env.PWD }}/templates"
        state: directory
        mode: '0755'
      become: no
      tags: [templates]

    - name: Create tests directory
      file:
        path: "{{ ansible_env.PWD }}/tests"
        state: directory
        mode: '0755'
      become: no
      tags: [templates]

    - name: Create Docker Compose template
      copy:
        content: |
          version: '3.8'

          services:
            pytorch-rocm:
              image: rocm/pytorch:latest
              container_name: pytorch-rocm
              devices:
                - /dev/kfd:/dev/kfd
                - /dev/dri:/dev/dri
              group_add:
                - video
                - render
              ipc: host
              cap_add:
                - SYS_PTRACE
              security_opt:
                - seccomp:unconfined
              volumes:
                - ~/Projects:/workspace/Projects
                - ~/Models:/workspace/Models
                - ~/DockerVolumes/pytorch:/workspace/data
                - /opt/rocm:/opt/rocm:ro
              working_dir: /workspace
              environment:
                - HIP_PLATFORM=amd
                - ROCM_PATH=/opt/rocm
                - HSA_OVERRIDE_GFX_VERSION=10.3.0  # Adjust for your GPU
              stdin_open: true
              tty: true
              restart: unless-stopped

            tensorflow-rocm:
              image: rocm/tensorflow:latest
              container_name: tensorflow-rocm
              devices:
                - /dev/kfd:/dev/kfd
                - /dev/dri:/dev/dri
              group_add:
                - video
                - render
              ipc: host
              cap_add:
                - SYS_PTRACE
              security_opt:
                - seccomp:unconfined
              volumes:
                - ~/Projects:/workspace/Projects
                - ~/Models:/workspace/Models
                - ~/DockerVolumes/tensorflow:/workspace/data
                - /opt/rocm:/opt/rocm:ro
              working_dir: /workspace
              environment:
                - HIP_PLATFORM=amd
                - ROCM_PATH=/opt/rocm
              stdin_open: true
              tty: true
              restart: unless-stopped

            jupyter-rocm:
              image: rocm/pytorch:latest
              container_name: jupyter-rocm
              devices:
                - /dev/kfd:/dev/kfd
                - /dev/dri:/dev/dri
              group_add:
                - video
                - render
              ipc: host
              cap_add:
                - SYS_PTRACE
              security_opt:
                - seccomp:unconfined
              volumes:
                - ~/Projects:/workspace/Projects
                - ~/Models:/workspace/Models
                - ~/DockerVolumes/jupyter:/workspace/data
                - /opt/rocm:/opt/rocm:ro
              working_dir: /workspace
              environment:
                - HIP_PLATFORM=amd
                - ROCM_PATH=/opt/rocm
                - HSA_OVERRIDE_GFX_VERSION=10.3.0
              ports:
                - "8888:8888"
              command: >
                bash -c "pip install jupyter jupyterlab &&
                         jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root --NotebookApp.token='' --NotebookApp.password=''"
              stdin_open: true
              tty: true
              restart: unless-stopped

          networks:
            default:
              driver: bridge
        dest: "{{ ansible_env.PWD }}/templates/docker-compose.ai-template.yml"
        mode: '0644'
      become: no
      tags: [templates]

    - name: Create ROCm Docker test script
      copy:
        content: |
          #!/bin/bash
          # Test ROCm functionality in Docker

          echo "Testing ROCm Docker integration..."

          # Test basic ROCm functionality
          echo "1. Testing basic ROCm container..."
          docker run --rm --device=/dev/kfd --device=/dev/dri --group-add video --group-add render \
              rocm/rocm-terminal:latest rocminfo | head -20

          echo -e "\n2. Testing PyTorch ROCm container..."
          docker run --rm --device=/dev/kfd --device=/dev/dri --group-add video --group-add render \
              rocm/pytorch:latest python3 -c "
          import torch
          print(f'PyTorch version: {torch.__version__}')
          print(f'ROCm available: {torch.cuda.is_available()}')
          if torch.cuda.is_available():
              print(f'GPU device: {torch.cuda.get_device_name(0)}')
              print(f'GPU count: {torch.cuda.device_count()}')
          else:
              print('No ROCm devices detected')
          "

          echo -e "\nROCm Docker test completed!"
        dest: "{{ ansible_env.PWD }}/tests/test-rocm-docker.sh"
        mode: '0755'
      become: no
      tags: [templates]

  # ===============================================
  # HANDLERS
  # ===============================================
  
  handlers:
    - name: restart docker
      systemd:
        name: docker
        state: restarted