---
# AI ROCm Docker Verification Playbook
# Test that all components are working correctly

- name: Verify AI System Setup
  hosts: localhost
  connection: local
  gather_facts: yes
  become: no
  
  tasks:
    - name: Check system information
      debug:
        msg: 
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Kernel: {{ ansible_kernel }}"
          - "Architecture: {{ ansible_architecture }}"
      tags: [info]

    - name: Check for AMD GPU
      shell: lspci | grep -i amd | grep -i vga
      register: gpu_check
      failed_when: false
      changed_when: false
      check_mode: no
      tags: [gpu]

    - name: Display GPU information
      debug:
        msg: "AMD GPU: {{ gpu_check.stdout if gpu_check.rc == 0 else 'No AMD GPU detected' }}"
      tags: [gpu]

    - name: Check ROCm installation
      stat:
        path: /opt/rocm
      register: rocm_dir
      tags: [rocm]

    - name: Verify ROCm directory exists
      assert:
        that: rocm_dir.stat.exists
        fail_msg: "ROCm directory not found at /opt/rocm"
        success_msg: "ROCm directory exists"
      tags: [rocm]

    - name: Test rocminfo command
      command: rocminfo
      register: rocminfo_output
      failed_when: false
      changed_when: false
      check_mode: no
      tags: [rocm]

    - name: Check rocminfo results
      debug:
        msg: "rocminfo {{ 'working' if rocminfo_output.rc == 0 else 'failed' }}"
      tags: [rocm]

    - name: Check Docker installation
      command: docker --version
      register: docker_version
      changed_when: false
      check_mode: no
      tags: [docker]

    - name: Display Docker version
      debug:
        msg: "{{ docker_version.stdout }}"
      tags: [docker]

    - name: Test Docker functionality
      command: docker run --rm hello-world
      register: docker_test
      failed_when: false
      changed_when: false
      check_mode: no
      tags: [docker]

    - name: Check Docker test results
      debug:
        msg: "Docker basic test {{ 'passed' if docker_test.rc == 0 else 'failed' }}"
      tags: [docker]

    - name: Check user group memberships
      command: groups
      register: user_groups
      changed_when: false
      check_mode: no
      tags: [permissions]

    - name: Verify user is in required groups
      assert:
        that:
          - "'render' in user_groups.stdout"
          - "'video' in user_groups.stdout"
          - "'docker' in user_groups.stdout"
        fail_msg: "User missing required group memberships"
        success_msg: "User has all required group memberships"
      tags: [permissions]

    - name: Check Projects directory
      stat:
        path: "{{ ansible_env.HOME }}/Projects"
      register: projects_dir
      tags: [workspace]

    - name: Verify Projects directory exists
      assert:
        that: projects_dir.stat.exists
        fail_msg: "Projects directory not found"
        success_msg: "Projects directory exists"
      tags: [workspace]

    - name: Check templates directory
      stat:
        path: "../templates"
      register: templates_dir
      tags: [files]

    - name: Check tests directory  
      stat:
        path: "../tests"
      register: tests_dir
      tags: [files]

    - name: Verify templates and tests directories exist
      debug:
        msg: 
          - "Templates directory: {{ 'exists' if templates_dir.stat.exists else 'missing' }}"
          - "Tests directory: {{ 'exists' if tests_dir.stat.exists else 'missing' }}"
      tags: [files]

    - name: Final verification summary
      debug:
        msg:
          - "âœ“ System: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "âœ“ ROCm: {{ 'Installed' if rocm_dir.stat.exists else 'Missing' }}"
          - "âœ“ Docker: {{ docker_version.stdout }}"
          - "âœ“ GPU: {{ gpu_check.stdout if gpu_check.rc == 0 else 'No AMD GPU detected' }}"
          - "âœ“ ROCm Info: {{ 'Working' if rocminfo_output.rc == 0 else 'Failed' }}"
          - "âœ“ Docker Test: {{ 'Passed' if docker_test.rc == 0 else 'Failed' }}"
          - "âœ“ Projects Directory: {{ 'exists' if projects_dir.stat.exists else 'missing' }}"
          - ""
          - "ðŸŽ‰ AI system setup verification completed!"
          - ""
          - "Next steps:"
          - "1. Reboot your system if you haven't already"
          - "2. Test ROCm with Docker containers"
          - "3. Start using your AI development environment"
      tags: [summary]